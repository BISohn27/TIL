# 마이크로서비스 아키텍처와 레디스

## 모놀리틱 아키텍처

- 전체 애플리케이션을 하나의 통합된 패키지로 개발 및 배포
- 서비스의 규모가 확장되면 유지보수의 복잡도 증가
- 한 개의 시스템에 문제 발생 -> 전체 시스템 장애
- 하나의 모듈 수정 -> 전체 애플리케이션 재배포 필요 -> 업데이트와 릴리스가 느려짐
- 하나의 파트에 리소스가 부족해도 서비스 전체를 확장해야 되기 때문에 리소스 낭비



## 마이크로서비스 아키텍처

- 독립된 각각의 모듈을 조립해 하나의 서비스를 만듬
- 기능별로 작게 나눠진 서비스 집합
- 서비스 별 업데이트, 테스트, 배포, 확장 수행
- 서비스 확장이 필요할 경우, 확장이 필요한 서비스만 업그레이드
- 서비스 간 독립성으로 한 서비스의 문제가 다른 서비스에 큰 영향을 주지 않게 만들 수 있음
- 개발 및 운영에 대규모 인원이 투입될 수 있는 서비스에 적합
- 소규모 팀에서는 서비스 분리로 인한 관리 복잡도와 운영 부담 증가



## 관계형 데이터 베이스

- 고정된 스키마
- 모든 데이터를 행과 열로 구성하며, 테이블 간 관계를 규정
- 관계 간 복잡성이 증가하면, 성능 향상을 위한 쿼리, 인덱스, 테이블 구조 최적화 필요
- 하나의 데이터베이스에 모든 데이터를 관리하는 모놀리틱 아키텍처에 중앙 관계형 데이터베이스가 표준
- ACID
  - Atomicity: 트랜잭션은 완벽하게 실행되거나 아예 실행되지 않음
  - Consistency: 트랜잭션 실행 전후로 제약 조건 만족
  - Isolation: 트랜잭션 실행 시 다른 트랜잭션에 영향 주지 않음
  - Durability: 성공적으로 수행된 트랜잭션은 영원히 결과가 반영
- 데이터의 크기와 구조를 예측할 수 없는 다차원적이거나 깊은 계층 구조를 가진 비정형 데이터 관리 힘듬



## NoSQL

- No SQL 또는 Not Only SQL

- 관계형 데이터베이스를 쿼리하기 위한 SQL를 사용하지 않는 데이터 저장소

- 여러 데이터베이스 타입이 존재하지만, 관계형 데이터베이스처럼 관계가 정의되지 않는 데이터를 저장하는 것이 공통 특징

- 특징

  - 실시간 응답
    - 데이터 저장소에서 데이터를 가져올 때 발생할 수 있는 지연 0 ~ 2ms

  - 확장성
    - 첫날의 트래픽, 세일 기간의 이벤트 등 예상치 못한 이벤트로 인한 트랜잭션 증가에 유연하게 확장
  - 고가용성
    - 장애 상황에서도 신속하게 복구돼 항상 사용할 수 있는 상태 유지 가능
  - 클라우드 네이티브
    - 클라우드 제공 업체에서 제공하는 **DBaas (Database-as-a-Service)**를 사용하여 적접 설치 없이 설치된 제품 사용 가능
    - 운영에 필요한 모니터링, 알람 제공
  - 단순성
    - 서비스가 세분화될 수록 관리 포인트가 늘어남
    - 관리 포인트를 줄일 수 있는 간단한 데이터 저장소에 대한 요구 증가
    - 데이터 모델이 모든 서비스에 최적화되지 않기 때문에 서비스 별 적절한 데이터 모델 사용 필요 (멀티 모델 데이터베이스)
  - 유연성
    - 비정형 데이터의 증가로, 비정형 데이터를 저장할 수 있는 적합한 데이터 저장소 필요
    - NoSQL의 경우 다양한 비정형 데이터를 저장할 수 있는 방법 제공

  

  ### NoSQL 데이터 저장소 유형

  - 그래프 유형

    - 노드, 엣지, 속성으로 데이터를 나타냄
    - 엣지는 시작 노드, 끝 노드, 유형, 방향을 가지는 상-하위 관계, 동장, 소유자 등의 정보 저장
    - 관계를 저장하고 표현할 때 유용
    - 저장되는 속성의 크기가 크거나 혹은 많은 속성을 저장해야 되는 경우에는 적합하지 않음
    - 친구 추천 서비스, 관심 분야나 구매 이력이 비슷한 다른 유저의 구입한 상품을 추천

  - 칼럼 유형

    - 테이블을 행이 아닌 열을 기준으로 저장
    - 하나의 열에 중첩된 키-값 형태로 저장 가능하여 기존 관계형 데이터베이스보다 유연한 스키마를 가짐
    - 대량의 데이터에 대한 집계 쿼리를 다른 유형보다 훨씬 빠르게 처리
    - 분석, 보고, 빅데이터 처리에 적합 (Cassandra, HBase)

  - 문서 유형

    - JSON 형태로 저장
    - 스키마가 정해져 있지 않아 데이터를 있는 그대로 저장
    - 항상 키와 연결되는 계층적 트리 구조
    - MongoDB, CouchDB, AWS DocumentDB

  - 키-값 유형

    - 단순하고 빠름
    - Key는 데이터를 정의하는 Primary Key 역할
    - 키를 통해 검색, 키를 삭제하면 값도 삭제
    - 데이터 저장이 간단하여 수평 확장에 용이
    - 게임이나 IOT와 같은 실시간 서비스에 빠른 응답 제공
    - AWS ElastiCache, AWS DynamoDB, Oracle NoSQL Database, Memcached

    

## 레디스

- Remote Dictionary Server

- 고성능 키-값 유형의 인메모리 NoSQL 데이터베이스

- 특징

  - 실시간 응답(빠른 성능)

    - 온디스크의 경우 데이터를 영구적으로 디스크에 저장
      - 자주 사용하는 데이터만 캐시되어 있어 자주 사용하지 않는 데이터를 찾을 때에는 디스크 탐색 필요
      - 디스크의 데이터를 페이지 단위로 메모리에 올린 뒤 메모리에서 데이터를 찾고, 없으면 다시 다른 페이지를 찾는 것을 반복
      - 디스크 접근 빈도가 증가할수록 시스템 성능 저하
    - 인메모리의 경우 메모리에 모든 데이터를 적재하기 때문에 빠름

  - 단순성

    - 키-값 형태로 저장하며, 값에는 다양한 형태를 지원
      - 문자열, hash, set 데이터 구조 지원
    - 테이블과 프로그램 언어 간 데이터 구조가 불일치 하는 **임피던스 불일치** 없음
    - 레디스는 싱글 스레드로 동작
      - 정확하게는 메인 스레드 1개, 별도 스레드 3개
      - 클라이언트의 커맨드는 싱글 스레드 이벤트 루프에서 처리
      - 하나의 코어만 있어도 사용할 수 있기 때문에 CPU가 적은 서버에서도 좋은 성능 발휘
      - 한 레디스 내 클라이언트 커맨드는 싱글 스레드로 처리 되기 때문에 동시성 문제 없음
      - 싱글 스레드로 동작하기 때문에 소요 시간이 긴 커맨드 때문에 지연 발생 가능
      - 반환이 느린 커맨드를 주의해서 사용해야 장애 발생 줄일 수 있음

  - 고가용성

    - 복제를 통해 여러 서버에 데이터 분산 시킬 수 있음
    - 센티널은 장애 상황을 탐지해 자동으로 페일오버 시킴
    - 클러스터 모드 사용 시 손쉬운 수평 확장 가능
      - 데이터를 자동으로 샤딩된 후 저장, 여러 개의 복제본 생성
      - 클러스터 버스라는 프로토콜을 이용해 서로 감시하여, 마스터 노드에 문제 발생 시 자동으로 페일오버 가능

  - 클라우드 네이티브

    - 클라우드 네이티브 환경에서 빠른 데이터 억세스 및 처리 지원
    - 여러 클라우드 제공업체의 서비스를 사용하는 멀티 클라우드 환경에서 여러 클라우드 환경에서 일관된 성능과 기능을 제공

    

## 마이크로서비스 아키텍처에서의 레디스

- 데이터 저장소

  - 마이크로 서비스 내에서 각 서비스 별 개별 저장소로 사용
  - 최소한의 리소스로 막대한 처리량
  - 고가용성을 위한 로드 밸런서나 프록시 추가 필요 없음
  - AOF(Append Only File)와 RDB(Redis Database) 형식으로 주기적으로 백업 가능

- 메세지 브로커

  - pub/sub
    - pub/sub 기능을 통해 1개의 채널에 데이터를 던져 해당 채널을 리스닝 하는 모든 소비자에 빠르게 메세지를 전달하는 간단한 메세지 기능 제공
    - pub/sub 기능은 모든 메세지 전달 뒤 삭제되는 일회성으로 **fire-and-forget** 패턴이 필요한 알림에 적합
  - list 메세지 큐
    - 레디스의 list 자료 구조는 push/pop이 가능한 연결 리스트이기 때문에 메세지 큐로 사용 가능, 블록킹 기능도 제공
  - stream
    - 계속해서 추가되는 append only 방식
    - 데이터를 읽을 수 있는 소비자 그룹이 존재해 데이터 분산 처리도 가능, 저장된 데이터를 시간대 별 검색 가능

  