# 레디스 센티널

- 마스터 노드에 장애가 생겨 레플리카로 마스터 노드를 변경해야 하는 경우
  - 레플리카 노드에 직접 접속하여 `REPLICA OF NO ONE` 커맨드를 입력해 읽기 전용 상태 해제
  - 애플리케이션 코드에서 레디스의 엔드포인트를 레플리카 IP로 변경
- 별도의 고가용성 기능을 사용하지 않을 경우 장애 처리 지연 발생
- **look aside** 구성으로 사용할 경우, 캐시 접근 불가 시 원본 데이터베이스 서버로 전부 접근하기 때문에 서버 부하 발생



## 센티널

- 데이터를 저장하는 레디스 인스턴스와는 별도의 프로세스로 동작하는 고가용성 프로세스
- 마스터 노드 장애 시 자동 페일오버 기능 제공하여 레디스 다운타임 최소화



### 센티널 기능

- 모니터링: 마스터, 레플리카 인스턴스의 상태를 실시간 모니터링
- 자동 페일오버: 마스터의 장애를 감지하고, 정상 상태의 레플리카 중 하나를 마스터로 승격 시킴, 기존 레플리카는 새로 승격된 마스터에 복제 연결
- 인스턴스 구성 정보: 센티널은 클라이언트에게 현재 마스터 정보 제공, 페일오버 발생 시 변경된 마스터 정보를 재전달
  - 클라이언트가 센티널에 마스터의 정보를 요청
  - 센티널이 현재 마스터 정보를 반환하면, 클라이언트는 해당 정보로 마스터에 데이터 조회



### 센티널의 분산 시스템

- **SPOF(Single Point Of Failure)**를 방지하기 위해 센티널은 최소 3대 이상일 때 동작하도록 설계
- 한 개의 센티널에 문제가 생겨도, 다른 센티널이 계속 역할 수행
- 클라이언트는 특정 센티널 인스턴스에 문제가 생기더라도 다른 센티널을 통해 마스터의 정보를 받아옴
- **쿼럼(quorum)**을 통해 마스터의 비정상 동작을 판단, 쿼럼을 만족하는 경우에만 페일오버 시작
  - 일반적으로 3개의 인스턴스에서는 쿼럼을 2로 설정
  - 과반수 선출 개념이기 때문에 센티널은 3대 이상의 홀수로 구성하는 것이 좋음



### 센티널 인스턴스 배치

​	![Introduction to Redis Replication and Redis Sentinels on Windows | by  Jen-Hsuan Hsieh (Sean) | ALayman | Medium](https://miro.medium.com/v2/resize:fit:2000/1*93xltnTwVZrF8gfXuEN1YA.jpeg)

- 센티널 인스턴스는 서로 영향을 받지 않는 각각의 서버에 설치하는 것이 좋음
- 마스터 노드에 장애가 발생하면, 센티널 인스턴스에서 쿼럼을 진행하여 접근 불가능한 상태라는 것을 동의 한 뒤 페일오버 진행
- `SENTINEL ckquorum`: 현재 센티널이 설정된 쿼럼을 만족하는지 확인



### 페일오버

- `SENTINEL FAILOVER <master name>`을 사용하여 수동 페일오버 가능
  - 마스터의 상태가 정상이라도 해당 커맨드로 마스터와 레플리카 간 롤 체인지 가능

- 자동 페일오버
  - 센티널은 주기적으로 마스터 노드에 `PING`을 보내 응답이 정상적으로 돌아오는지 확인
  - `sentinel.conf`에 지정된 `down-after-milliseconds` 시간 동안 마스터에서 응답이 오지 않으면 마스터의 상태가 정상적이지 않다고 판단 (기본값 30초)



## 센티널 운영

- 복제 우선순위
  - 모든 레디스 인스턴스는 `replica-priority`를 가짐
  - 위 값이 가장 작은 노드가 마스터로 선출
  - 기본 값은 100이며, 위 값이 0인 노드는 절대 마스터로 선출되지 않음
- 실행 도중 모니터링 할 마스터를 추가, 제거, 변경 가능
  - 설정 변경이 다른 센티널로 전파되지 않기 때문에 마스터를 모니터링 하는 센터널 마다 모두 설정을 적용해야 함
  - 마스터 추가: `SENTINEL MONITOR <master name> <ip> <port> <quorum>`
  - 마스터 제거: `SENTINEL REMOVE <master name>`
- 센티널은 페일오버 뒤 계속 접근이 불가능한 기존 마스터나 장애로 접근이 불가능한 레플리카 노드 등 비정상적이라 판단 된 노드도 계속 모니터링 시도
  - 접근 불가능한 노드가 더이상 사용하지 못하는 경우 해당 노드 모니터링 중단 필요
  - `SENTINEL RESET <master name>`
  - 위 커맨드를 실행하면 센티널 인스턴스의 상태 정보를 초기화 하면서 모니터링 하고 있는 마스터, 레플리카, 다른 센티널 인스턴스의 정보를 새로 고침
  - 마스터 이름을 직접 지정할 수도 있고, `*` 와일드 카드를 사용하여 모니터링하고 있는 전체 마스터 정보를 초기화할 수도 있음
- 센티널 노드의 추가는 마스터를 모니터링 하도록 설정하면, 자동 검색 메커니즘을 통해 자동으로 기존에 실행 중이던 다른 센티널의 known-list에 추가
  - 한번에 여러 대의 센티널을 추가해야 되는 경우, 10초 간격을 두면서 천천히 추가하는 것이 오류 발생 가능성을 낮춤
- 기존 센티널을 제거하기 위해서는 `SENTINEL RESET *` 커맨드를 사용해 센티널이 모니터링 하고 있는 정보를 리셋
  - 센티널 인스턴스 사이에 최소 30초 대기 시간을 가지며 차례대로 커맨드를 실행하는 것이 좋음



### 센티널의 자동 페일오버 과정

1. 마스터의 장애 상황 감지
   - `down-after-milliseconds`에 지정된 값 이상 동안 마스터에서 `PING`에 대해 유효한 응답(`+PING`, `-LOADING`, `-MASTERDOWN`)이 오지 않을 경우 마스터에 문제가 생겼다고 판단
2. `sdown`, `odown` 실패 상태 전환
   - 마스터에서 유효한 `PING` 응답을 받지 못하는 경우, 응답을 받지 못한 센티널은 해당 마스터의 상태를  `sdown(subjectly down)`으로 변경
   - 다른 센티널 인스턴스로 `SENTINEL is-master-down-by-addr <master-ip> <master-port> <current-epoch> <*>` 커맨드를 보내 장애 사실 전파
   - 다른 센티널은 위 커맨드에 대한 응답으로 해당 마스터의 장애를 인지 여부를 보냄
   - 쿼럼 값 이상의 센티널에서 해당 마스터 장애를 인지했다면, 커맨드를 보낸 센티널 노드는 해당 마스터의 상태를 `odown(objectly down)`으로 변경
   - 센티널은 마스터 노드에 대해서만 `odown`상태로 변경하고, 모니터링 하는 레플리카 노드에 장애가 발생하면 `sdown` 상태로만 플래깅
   - 따라서 장애 전파는 오직 마스터 노드에 대해서만 진행
   - `sdown` 상태의 레플리카 노드는 마스터로 승격 되지 않음
3. 에포크 증가
   - 페일오버를 진행하는 센티널 노드는 페일오버를 시작하기 전 에포크 값을 하나 증가 시킴
   - 에포크 값을 통해 페일오버의 버전을 관리
   - 처음 페일오버가 일어나면 에포크 값은 1
   - 새로운 페일오버가 발생할 때마다 에포크 값을 하나씩 증가 시킴
   - 에포크 값이 동일하면, 모든 센티널 노드가 같은 작업을 시도하고 있다고 간주
4. 센티널 리더 선출
   - 에포크를 증가시킨 센티널은 다른 센티널 노드에게 센티널 리더 선출을 위한 투표 진행 메세지를 보냄
   - 투표 진행 메세지에는 증가시킨 에포크 값을 함께 전달
   - 메세지를 받은 센티널 노드는 자신의 현재 에포크 값보다 전달 받은 에포크 값이 클 경우 자신의 에포크 값을 증가 시키고, 새로운 리더에게 투표하겠다고 응답
   - 전달 받은 에포크 값이 자신의 에포크 값과 동일할 경우, 이미 리더로 선출한 센티널 ID를 응답
   - 하나의 에포크에서는 하나의 센티널에게만 투표 가능, 투표 결과는 변경 불가
   - 마스터 노드의 장애 판단은 쿼럼 값 이상의 동의 필요, 하지만 페일오버는 **실제 센티널 개수 중 과반 이상의 센티널 동의**를 얻어야지만 리더 선출
     - 쿼럼 값보다 많은 센티널이 리더 선출에 동의했다고 해도, 실제 센티널 수(known-list)의 과반이 되지 않으면 페일오버는 발생하지 않음
5. 레플리카 선정 후 마스터로 승격
   - 마스터 승격 자격
     - `redis.conf` 파일에 명시된 `replica-priority`가 낮은 레플리카
     - 마스터로부터 더 많은 데이터를 수신한 레플리카 (오프셋)
     - 2개의 조건이 동일하다면, `runID`가 사전 순으로 작은 레플리카
   - 레플리카에 `slaveof no one` 커맨드를 실행하여 기존 마스터와의 복제 연결을 끊음
6. 복제 연결 변경
   - 새로 승격된 마스터로 레플리카들이 연결될 수 있도록 레플리카마다 `replicaof <new-ip> <new-port>` 커맨드 실행
   - 복제 그룹의 모든 센티널 노드에서도 레디스의 구성 정보 변경



### 스플릿 브레인 현상

- 네트워크 파티션 이슈로 데이터 저장소 간 연결이 끊어진 상태에서 끊어진 파티션들이 서로 정상적인 서비스라고 인식하는 현상
- 마스터 노드가 존재하는 네트워크 파티션과 과반 이상의 레플리카가 존재하는 네트워크 파티션 간 연결이 끊어진 경우
  - 마스터 노드 쪽 센티널은 마스터가 정상이라고 판단
  - 레플리카 노드 쪽 센티널들은 마스터가 비정상이라고 판단하고 레플리카 내에서 새로운 마스터를 승격
  - 기존 마스터에 장애가 발생하지 않았다면 기존 마스터에 연결된 클라이언트는 네트워크 단절이 없을 경우 기존대로 계속 마스터 노드에 데이터 변경
  - 승격된 마스터 쪽 클라이언트는 센티널의 마스터 정보 변경에 따라 새로 승격한 마스터에 접근하여 데이터 변경
  - 네트워크 단절이 복구될 경우, 기존 마스터가 새로 승격된 마스터로 복제 연결되면서 기존 마스터에 저장된 모든 데이터는 복제 연결 과정에서 유실